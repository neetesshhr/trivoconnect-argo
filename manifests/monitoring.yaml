# This file deploys Prometheus, Grafana, Loki, and Promtail
# All components will be installed in the "monitoring" namespace.

# --- 1. PROMETHEUS (Metrics Server) & GRAFANA (Dashboard) ---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: monitoring-stack
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 58.1.0
    helm:
      values: |
        # This chart's components will go into the "monitoring" namespace
        namespace: "monitoring"
        
        grafana:
          persistence:
            enabled: true
            type: pvc
            size: 5Gi
            
          ingress:
            enabled: true
            ingressClassName: nginx
            annotations:
              cert-manager.io/cluster-issuer: "letsencrypt-http"
            hosts:
              - grafana.trivoconnect.com
            tls:
              - hosts:
                - grafana.trivoconnect.com
                secretName: grafana-tls-secret

          additionalDataSources:
            - name: Loki
              type: loki
              # --- THIS IS THE CHANGE ---
              # Find Loki in the *monitoring* namespace
              url: http://loki-stack.monitoring.svc.cluster.local:3100
              # --- END OF CHANGE ---
              access: proxy
              jsonData: {}

        prometheus:
          prometheusSpec:
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 10Gi

  destination:
    # This Application resource itself lives in the "argocd" namespace
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - "CreateNamespace=true"

---

# --- 2. LOKI (Log Server) & PROMTAIL (Log Agent) ---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: logging-stack
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: loki-stack
    targetRevision: 2.13.0
    helm:
      values: |
        # --- THIS IS THE CHANGE ---
        # This chart's components will also go into the "monitoring" namespace
        namespace: "monitoring"
        # --- END OF CHANGE ---

        loki:
          persistence:
            enabled: true
            size: 10Gi
        promtail:
          enabled: true
        grafana:
          enabled: false

  destination:
    # This Application resource itself lives in the "argocd" namespace
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - "CreateNamespace=true"