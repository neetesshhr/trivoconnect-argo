# This file deploys Prometheus, Grafana, Loki, and Promtail
# All components will be installed in the "monitoring" namespace.

# --- 1. PROMETHEUS (Metrics Server) & GRAFANA (Dashboard) ---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: monitoring-stack
  # This resource lives in the 'argocd' namespace
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 58.1.0
    helm:
      values: |
        # This value tells the CHART to create its resources
        # in the 'monitoring' namespace.
        namespace: "monitoring"
        
        grafana:
          persistence:
            enabled: true
            type: pvc
            size: 5Gi
            
          ingress:
            enabled: true
            ingressClassName: nginx
            annotations:
              cert-manager.io/cluster-issuer: "letsencrypt-http"
              nginx.ingress.kubernetes.io/ssl-redirect: "false"
            hosts:
              - grafana.trivoconnect.com
            tls:
              - hosts:
                - grafana.trivoconnect.com
                secretName: grafana-tls-secret

          additionalDataSources:
            - name: Loki
              type: loki
              # This now correctly finds Loki in the same 'monitoring' namespace
              url: http://loki-stack.monitoring.svc.cluster.local:3100
              access: proxy
              jsonData: {}

        prometheus:
          prometheusSpec:
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 10Gi

  destination:
    server: https://kubernetes.default.svc
    # --- THIS IS THE FIX ---
    # This tells Argo CD to deploy the chart's resources
    # into the 'monitoring' namespace.
    namespace: monitoring
    # --- END OF FIX ---
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - "CreateNamespace=true" # This will now create the 'monitoring' namespace
    - "Replace=true"

---

# --- 2. LOKI (Log Server) & PROMTAIL (Log Agent) ---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: logging-stack
  # This resource lives in the 'argocd' namespace
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: loki-stack
    targetRevision: 2.13.0
    helm:
      values: |
        # This value tells the CHART to create its resources
        # in the 'monitoring' namespace.
        namespace: "monitoring"
        
        loki:
          persistence:
            enabled: true
            size: 10Gi
        promtail:
          enabled: true
        grafana:
          enabled: false

  destination:
    server: https://kubernetes.default.svc
    # --- THIS IS THE FIX ---
    # This also tells Argo CD to deploy the chart's resources
    # into the 'monitoring' namespace.
    namespace: monitoring
    # --- END OF FIX ---
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - "CreateNamespace=true" # This will also see the 'monitoring' namespace